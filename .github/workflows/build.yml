name: build
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0 # get entire git tree, required for nerdbank gitversioning
    - uses: Azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    - uses: Azure/get-keyvault-secrets@v1.1
      with:
        keyvault: "ActionsBuild"
        secrets: 'NuGetUsername, NuGetPassword, NuGetEndpoint'
      id: azureSecrets
    - name: Build project
      shell: pwsh
      run: ./build.ps1
    - name: Push it to GitHub
      run: |
        dotnet nuget add source --username ${{ steps.azureSecrets.outputs.NuGetUsername }} --password ${{ steps.azureSecrets.outputs.NuGetPassword }} --store-password-in-clear-text --name Target "${{ steps.azureSecrets.outputs.NuGetEndpoint }}"
        dotnet nuget push --skip-duplicate '.build/packages/*.nupkg' -k "${{ steps.azureSecrets.outputs.NuGetUsername }}:${{ steps.azureSecrets.outputs.NuGetPassword }}" -s Target
